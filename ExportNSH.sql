USE yfCLT;
GO

DECLARE @RecordSeries VARCHAR(16) = 'SR';

-- Create a Table Variable for DocIdMetaData Values
DECLARE @SelectedDocIdMetaData TABLE (DocIdMetaData VARCHAR(255));

-- Insert Specific DocIdMetaData Values for Filtering
INSERT INTO @SelectedDocIdMetaData (DocIdMetaData)
VALUES 
('M_948527-1')
,('M_948527-3')
,('M_981142-1')
,('M_981142-11')
,('M_981142-13')
,('M_981142-3')
,('M_981142-5')
,('M_981142-7')
,('M_981142-9')
,('M_1046170-1')
,('M_1046170-3')
,('M_1046170-5')
,('M_1046170-7')
,('M_1046170-9')
,('M_960785-1')
,('M_960785-11')
,('M_960785-13')
,('M_960785-15')
,('M_960785-3')
,('M_960785-5')
,('M_960785-7')
,('M_960785-9')
,('M_1046211-1')
,('M_1046211-3')
,('M_1046211-5')
,('M_1046211-7')
,('3975319-1')
,('M_974860-1')
,('M_974860-11')
,('M_974860-13')
,('M_974860-15')
,('M_974860-3')
,('M_974860-5')
,('M_974860-7')
,('M_974860-9')
,('M_672766-1')
,('M_672762-1')
,('M_672762-3')
,('M_672762-5')
,('M_888522-1')
,('M_888522-3')
,('M_888522-5')
,('M_888522-7')
,('M_955592-1')
,('M_955592-11')
,('M_955592-13')
,('M_955592-15')
,('M_955592-3')
,('M_955592-5')
,('M_955592-7')
,('M_955592-9')
,('M_983663-1')
,('M_983663-3')
,('M_983663-5')
,('M_983663-7')
,('M_983663-9')
,('M_992325-1')
,('M_992325-11')
,('M_992325-13')
,('M_992325-15')
,('M_992325-17')
,('M_992325-19')
,('M_992325-3')
,('M_992325-5')
,('M_992325-7')
,('M_992325-9')
,('M_992387-1')
,('M_992387-11')
,('M_992387-13')
,('M_992387-15')
,('M_992387-3')
,('M_992387-5')
,('M_992387-7')
,('M_992387-9')
,('4082615-1')
,('M_983866-1')
,('M_983866-3')
,('M_983866-5')
,('M_983866-7')
,('M_983866-9')
,('M_992616-1')
,('M_992616-3')
,('M_992616-5')
,('M_992616-7')
,('M_992616-9')
,('M_1033093-1')
,('M_1033093-11')
,('M_1033093-13')
,('M_1033093-15')
,('M_1033093-17')
,('M_1033093-3')
,('M_1033093-5')
,('M_1033093-7')
,('M_1033093-9')
,('M_961228-1')
,('M_961228-11')
,('M_961228-3')
,('M_961228-5')
,('M_961228-7')
,('M_961228-9')
,('M_983959-1')
,('M_983959-11')
,('M_983959-13')
,('M_983959-3')
,('M_983959-5')
,('M_983959-7')
,('M_983959-9')
,('4593354-1')
,('3919169-1')
,('M_1046499-1')
,('M_1046499-3')
,('M_1046499-5')
,('M_1046499-7')
,('M_1046499-9')
,('4591858-1')
,('M_1047545-1')
,('M_1047545-11')
,('M_1047545-13')
,('M_1047545-3')
,('M_1047545-5')
,('M_1047545-7')
,('M_1047545-9')
,('4591918-1')
,('M_993925-1')
,('M_993925-3')
,('M_993925-5')
,('M_993925-7')
,('M_1047581-1')
,('M_1047581-11')
,('M_1047581-3')
,('M_1047581-5')
,('M_1047581-7')
,('M_1047581-9')
,('3975204-1')
,('M_1047614-1')
,('M_1047614-11')
,('M_1047614-3')
,('M_1047614-5')
,('M_1047614-7')
,('M_1047614-9')
,('4592019-1')
,('M_975317-1')
,('M_975317-11')
,('M_975317-13')
,('M_975317-3')
,('M_975317-5')
,('M_975317-7')
,('M_975317-9')
,('M_975347-1')
,('M_975347-3')
,('M_975347-5')
,('M_975347-7')
,('M_955408-1')
,('M_955408-11')
,('M_955408-13')
,('M_955408-3')
,('M_955408-5')
,('M_955408-7')
,('M_955408-9')
,('M_1047645-1')
,('M_1047645-3')
,('M_1047645-5')
,('M_1047645-7')
,('3975161-1')
,('M_993952-1')
,('M_993952-11')
,('M_993952-3')
,('M_993952-5')
,('M_993952-7')
,('M_993952-9')
,('M_955378-1')
,('M_955378-11')
,('M_955378-3')
,('M_955378-5')
,('M_955378-7')
,('M_955378-9')
,('M_1041671-1')
,('M_1041671-11')
,('M_1041671-13')
,('M_1041671-15')
,('M_1041671-17')
,('M_1041671-19')
,('M_1041671-21')
,('M_1041671-23')
,('M_1041671-3')
,('M_1041671-5')
,('M_1041671-7')
,('M_1041671-9')
,('M_888947-1')
,('M_888947-3')
,('M_888947-5')
,('M_888947-7')
,('M_1436297-1')
,('M_1436297-11')
,('M_1436297-3')
,('M_1436297-5')
,('M_1436297-7')
,('M_1436297-9')
,('M_888994-1')
,('M_888994-3')
,('M_888994-5')
,('M_888994-7')
,('M_1047797-1')
,('M_1047797-11')
,('M_1047797-13')
,('M_1047797-3')
,('M_1047797-5')
,('M_1047797-7')
,('M_1047797-9')
,('4592179-1')
,('4592179-2')
,('M_1514717-1')
,('M_1514717-11')
,('M_1514717-13')
,('M_1514717-15')
,('M_1514717-17')
,('M_1514717-19')
,('M_1514717-3')
,('M_1514717-5')
,('M_1514717-7')
,('M_1514717-9')
,('M_966780-1')
,('M_966780-3')
,('M_966780-5')
,('M_966780-7')
,('M_966780-9')
,('M_948606-1')
,('M_948606-11')
,('M_948606-3')
,('M_948606-5')
,('M_948606-7')
,('M_948606-9')
,('3962523-1')
,('M_1069598-1')
,('M_1069598-11')
,('M_1069598-13')
,('M_1069598-15')
,('M_1069598-17')
,('M_1069598-19')
,('M_1069598-21')
,('M_1069598-23')
,('M_1069598-25')
,('M_1069598-27')
,('M_1069598-3')
,('M_1069598-5')
,('M_1069598-7')
,('M_1069598-9')
,('M_966988-1')
,('M_966988-3')
,('M_966988-5')
,('M_966988-7')
,('M_966988-9')
,('4142074-1')
,('398450-1')
,('M_948664-1')
,('M_948664-11')
,('M_948664-3')
,('M_948664-5')
,('M_948664-7')
,('M_948664-9')
,('3962578-1')
,('3962578-2')
,('M_955228-1')
,('M_955228-11')
,('M_955228-13')
,('M_955228-15')
,('M_955228-17')
,('M_955228-19')
,('M_955228-3')
,('M_955228-5')
,('M_955228-7')
,('M_955228-9')
,('M_1047826-1')
,('M_1047826-3')
,('M_1047826-5')
,('M_1047826-7')
,('M_1047826-9')
,('3978959-1')
,('3978959-2')
,('M_955037-1')
,('M_955037-11')
,('M_955037-13')
,('M_955037-15')
,('M_955037-3')
,('M_955037-5')
,('M_955037-7')
,('M_955037-9')
,('M_948859-1')
,('M_948859-3')
,('M_948859-5')
,('M_948859-7')
,('M_948859-9')
,('3964252-1')
,('M_948890-1')
,('M_948890-3')
,('M_948890-5')
,('M_948890-7')
,('M_948890-9')
,('3962697-1')
,('M_1048281-1')
,('M_1048281-11')
,('M_1048281-3')
,('M_1048281-5')
,('M_1048281-7')
,('M_1048281-9')
,('3979169-1')
,('M_947221-1')
,('M_947255-1')
,('M_947255-3')
,('M_947255-5')
,('M_947255-7')
,('M_947255-9')
,('M_947362-1')
,('M_947362-3')
,('M_947362-5')
,('M_947362-7')
,('M_947362-9')
,('M_1048295-1')
,('M_1048295-3')
,('M_1048295-5')
,('M_1048295-7')
,('M_1048295-9')
,('M_978913-1')
,('M_978913-3')
,('M_978913-5')
,('M_978913-7')
,('M_978913-9')
,('M_991440-1')
,('M_991440-3')
,('M_991440-5')
,('M_991440-7')
,('M_948893-1')
,('M_948893-3')
,('3962763-1')
,('4593645-1')
,('M_978966-1')
,('M_978966-3')
,('M_978966-5')
,('M_978966-7')
,('4193366-1')
,('M_947769-1')
,('M_947769-11')
,('M_947769-13')
,('M_947769-15')
,('M_947769-3')
,('M_947769-5')
,('M_947769-7')
,('M_947769-9')
,('4052668-1')
,('M_948116-1')
,('M_948116-3')
,('M_948116-5')
,('M_948116-7')
,('M_948116-9')
,('3623098-1')
,('3623098-11')
,('3623098-3')
,('3623098-5')
,('3623098-7')
,('3623098-9')
,('4611849-1')
,('4611849-2')
,('M_992003-1')
,('M_992003-3')
,('M_992003-5')
,('M_992003-7')
,('4009429-1')
,('M_1035636-1')
,('M_1035636-11')
,('M_1035636-13')
,('M_1035636-15')
,('M_1035636-3')
,('M_1035636-5')
,('M_1035636-7')
,('M_1035636-9')
,('M_967498-1')
,('M_967498-3')
,('M_967498-5')
,('M_967498-7')
,('M_967498-9')
,('3981347-1')
,('M_1049419-1')
,('M_1049419-11')
,('M_1049419-13')
,('M_1049419-15')
,('M_1049419-17')
,('M_1049419-3')
,('M_1049419-5')
,('M_1049419-7')
,('M_1049419-9')
,('M_979532-1')
,('M_979532-3')
,('M_979532-5')
,('M_979532-7')
,('M_979532-9')
,('M_948187-1')
,('M_948187-11')
,('M_948187-13')
,('M_948187-3')
,('M_948187-5')
,('M_948187-7')
,('M_948187-9')
,('M_1036219-1')
,('M_1036219-11')
,('M_1036219-13')
,('M_1036219-15')
,('M_1036219-3')
,('M_1036219-5')
,('M_1036219-7')
,('M_1036219-9')
,('M_968302-1')
,('M_968302-3')
,('M_968302-5')
,('M_968195-1')
,('M_968195-3')
,('M_968195-5')
,('M_968195-7')
,('M_954499-1')
,('M_954499-11')
,('M_954499-13')
,('M_954499-15')
,('M_954499-3')
,('M_954499-5')
,('M_954499-7')
,('M_954499-9')
,('M_948898-1')
,('M_948898-3')
,('M_948898-5')
,('M_948898-7')
,('3962836-1')
,('M_948900-1')
,('M_1036299-1')
,('M_1036299-11')
,('M_1036299-13')
,('M_1036299-3')
,('M_1036299-5')
,('M_1036299-7')
,('M_1036299-9')
,('M_1036371-1')
,('M_1036371-11')
,('M_1036371-3')
,('M_1036371-5')
,('M_1036371-7')
,('M_1036371-9')
,('M_1049467-1')
,('M_1049467-11')
,('M_1049467-3')
,('M_1049467-5')
,('M_1049467-7')
,('M_1049467-9')
,('3981056-1')
,('M_954117-1')
,('M_954117-3')
,('M_954117-5')
,('M_954117-7')
,('M_954117-9')
,('4145873-1')
,('M_1036524-1')
,('M_1036524-11')
,('M_1036524-3')
,('M_1036524-5')
,('M_1036524-7')
,('M_1036524-9')
,('M_954047-1')
,('M_954047-3')
,('M_954047-5')
,('M_954047-7')
,('M_954047-9')
,('M_953994-1')
,('M_953994-11')
,('M_953994-3')
,('M_953994-5')
,('M_953994-7')
,('M_953994-9')
,('M_992091-1')
,('M_992091-3')
,('M_992091-5')
,('4040407-1')
,('M_1049542-1')
,('M_1049542-3')
,('3987513-1')
,('M_948281-1')
,('M_948281-3')
,('4085122-1')
,('4041774-1')
,('3981089-1')
,('3987551-1')
,('M_1053752-1')
,('M_1053752-11')
,('M_1053752-13')
,('M_1053752-3')
,('M_1053752-5')
,('M_1053752-7')
,('M_1053752-9')
,('3962940-1')
,('M_969090-1')
,('M_969090-3')
,('3963013-1')
,('339456-1')
,('M_955480-1')
,('M_955480-3')
,('M_955480-5')
,('M_955480-7')
,('M_955480-9')
,('232115-1')
,('232465-1')
,('M_991072-1')
,('M_991072-3')
,('M_991072-5')
,('M_991072-7')
,('M_991072-9')
,('4017427-1')
,('M_975506-1')
,('M_975506-3')
,('M_975506-5')
,('M_975506-7')
,('M_991162-1')
,('M_991162-3')
,('M_991162-5')
,('M_991162-7')
,('4017310-1')
,('M_954909-1')
,('M_954909-3')
,('M_954909-5')
,('4507486-1')
,('M_992038-1')
,('M_992038-11')
,('M_992038-3')
,('M_992038-5')
,('M_992038-7')
,('M_992038-9')
,('4009395-1')
,('3335461')
,('3335463')
,('3335465')
,('3335467')
,('3335469')
,('3335471')
,('3335451')
,('3335453')
,('3335455')
,('3335457')
,('3335459')
,('346290-1')
,('346290-3')
,('3335383')
,('3335387')
,('3335395')
,('3335365')
,('3335369')
,('3335371')
,('3335373')
,('3335319')
,('3335331')
,('3335347')
,('3335349')
,('3335355')
,('3335359')
,('242727-1')
,('242818-1')
,('240336-1')
,('3317761')
,('240448-1')
,('240775-1')
,('241609-1')
,('243089-1')
,('248603-1')
,('248603-3')
,('243295-1')
,('236657-1')
,('236657-3')
,('242188-1')
,('242279-1')
,('242545-1')
,('242545-3')
,('236900-1')
,('237177-1')
,('4544106-1')
,('197218-1')
,('M_945812-1')
,('M_945812-11')
,('M_945812-3')
,('M_945812-5')
,('M_945812-7')
,('M_945812-9')
,('4508708-1')
,('3281456')
,('3281458')
,('M_1384102-1')
,('4507723-1')
,('4504073-1')
,('248552-1')
,('248552-3')
,('3271492')
,('3271494')
,('3267423')
,('4507325-1')
,('4508551-1')
,('4504416-1')
,('4488966-1')
,('248454-1')
,('217786-1')
,('249670-1')
,('4489953-1')
,('4507387-1')
,('4490715-1')
,('3271496')
,('3271498')
,('3271500')
,('237955-1')
,('3962664-1')
,('217349-1')
,('216429-1')
,('M_1383348-1')
,('4489961-1')
,('4504514-1')
,('244314-1')
,('247416-1')
,('M_1384336-1')
,('4489056-1')
,('4489118-1')
,('198468-1')
,('216742-1')
,('218328-5')
,('218328-1')
,('218328-3')
,('M_1400627-1')
,('256653-1')
,('248045-1')
,('248268-1')
,('248217-1')
,('4504895-1')
,('4507673-1')
,('4509498-1')
,('4504903-1')
,('344985-1')
,('344985-3')
,('242909-1')
,('242909-3')
,('M_1053301-1')
,('3801369-1')
,('M_1332722-1')
,('M_1332722-3')
,('M_1332722-5')
,('3379203')
,('3379205')
,('3379207')
,('3379197')
,('3379199')
,('3379201')
,('M_765567-1')
,('M_765567-3')
,('M_765578-1')
,('M_765578-3')
,('M_765578-5')
,('M_765578-7')
,('M_765578-9')
,('3274238')
,('3274240')
,('3274242')
,('3274228')
,('3274230')
,('3274232')
,('3274234')
,('3274236')
,('3277794')
,('3277796')
,('3277798')
,('3277800')
,('3277802')
,('3277788')
,('3277790')
,('3277792')
,('M_893521-1')
,('M_893521-11')
,('M_893521-13')
,('M_893521-15')
,('M_893521-3')
,('M_893521-5')
,('M_893521-7')
,('M_893521-9')
,('3277830')
,('3277832')
,('3277834')
,('3277836')
,('3277822')
,('3277824')
,('3277826')
,('3277828')
,('3281470')
,('3281472')
,('3281474')
,('M_1081635-1')
,('M_706658-1')
,('M_706658-3')
,('3814970-1')
,('3281486')
,('3281488')
,('3281490')
,('3281492')
,('3281494')
,('3281496')
,('3281786')
,('3281788')
,('3281790')
,('3281498')
,('3281500')
,('3281502')
,('3815065-1')
,('3815065-2')
,('M_723013-1')
,('M_723013-3')
,('M_723013-5')
,('M_723066-1')
,('M_723066-3')
,('M_723066-5')
,('3281802')
,('3281804')
,('3281806')
,('M_1081731-1')
,('3287254')
,('3287256')
,('3287246')
,('3287248')
,('3287250')
,('3287252')
,('3804261-1')
,('3287266')
,('3287268')
,('3287270')
,('3287258')
,('3287260')
,('3287262')
,('3287264')
,('3294851')
,('3294853')
,('3294855')
,('3294857')
,('3294859')
,('3816487-1')
,('3816487-2')
,('3294837')
,('3294839')
,('3294841')
,('3294843')
,('3294845')
,('3294847')
,('3294849')
,('3294875')
,('3294877')
,('3294879')
,('3294861')
,('3294863')
,('3294865')
,('3294867')
,('3294869')
,('3294871')
,('3294873')
,('3300585')
,('3300587')
,('3300589')
,('3300591')
,('3300593')
,('3300595')
,('3300597')
,('3300599')
,('3300601')
,('3300603')
,('3300605')
,('3300607')
,('3300609')
,('3816639-1')
,('3300611')
,('3300613')
,('3300615')
,('3300617')
,('3300619')
,('3300621')
,('3804266-1')
,('3300623')
,('3300625')
,('3300627')
,('3300629')
,('M_1081834-1')
,('M_725428-1')
,('M_725428-3')
,('M_725428-5')
,('M_725428-7')
,('M_725428-9')
,('M_725426-1')
,('M_725426-3')
,('M_725426-5')
,('3804276-1')
,('3300635')
,('3300637')
,('3300639')
,('3300631')
,('3300633')
,('3804281-1')
,('3300643')
,('3300645')
,('3300647')
,('3300641')
,('3804289-1')
,('3300649')
,('3300651')
,('3300653')
,('3300655')
,('3300657')
,('3300659')
,('3300658-1')
,('3300661')
,('3300663')
,('3804294-1')
,('3300665')
,('3300667')
,('3300669')
,('4574892-1')
,('3304437')
,('3304439')
,('3304441')
,('3305316')
,('3305318')
,('3305320')
,('M_1081917-1')
,('3308077')
,('3308079')
,('3308081')
,('3308069')
,('3308071')
,('3308073')
,('3308075')
,('3308083')
,('3308091')
,('3308093')
,('3308095')
,('3816665-1')
,('3308085')
,('3308087')
,('3308089')
,('M_729281-1')
,('M_729281-3')
,('M_729281-5')
,('M_729283-1')
,('M_729283-3')
,('M_729283-5')
,('M_729283-7')
,('3308109')
,('3308111')
,('3308113')
,('3308115')
,('3308117')
,('3308119')
,('3308131')
,('3308133')
,('3308121')
,('3308123')
,('3308125')
,('3308127')
,('3308129')
,('M_709242-1')
,('M_709242-3')
,('M_709242-5')
,('M_709249-1')
,('M_709249-3')
,('3822158-1')
,('3308135')
,('3308137')
,('3308139')
,('3308141')
,('3308143')
,('3804304-1')
,('3309563')
,('3309565')
,('3309567')
,('3309569')
,('3309557')
,('3309559')
,('3309561')
,('M_1081978-1')
,('3310650')
,('3310652')
,('3310654')
,('3310636')
,('3310638')
,('3310640')
,('3310642')
,('3310644')
,('3310646')
,('3310648')
,('M_1081959-1')
,('3335435')
,('3335437')
,('3335439')
,('3335423')
,('3335425')
,('3335427')
,('3335431')
,('3335433')
,('3335445')
,('3335447')
,('3335449')
,('3335441')
,('3335443')
,('3804320-1')
,('3300573')
,('3300575')
,('3300577')
,('3300579')
,('3300581')
,('3300583')
,('3313540')
,('3313542')
,('3313544')
,('3313534')
,('3313536')
,('3313538')
,('3315110')
,('3315112')
,('3315114')
,('3315116')
,('3315118')
,('3315120')
,('3315122')
,('3315124')
,('3315126')
,('3315128')
,('3315130')
,('3315132')
,('3315134')
,('M_710059-1')
,('M_710059-3')
,('M_710059-5')
,('M_710078-1')
,('M_710078-3')
,('M_710078-5')
,('3822378-1')
,('3315940')
,('3315942')
,('3316127')
,('3822597-1')
,('3316129')
,('3316407')
,('3316409')
,('3316411')
,('3328835')
,('3328837')
,('3328839')
,('3328833')
,('3328841')
,('3328843')
,('3328845')
,('3822703-1')
,('3328851')
,('3328853')
,('3328855')
,('3328847')
,('3328849')
,('3328865')
,('3328867')
,('3328869')
,('3328871')
,('3328857')
,('3328859')
,('3328861')
,('3328863')
,('M_1084166-1')
,('3328889')
,('3328891')
,('3328893')
,('3328887')
,('3805114-1')
,('3328873')
,('3328875')
,('3328877')
,('3328879')
,('3328881')
,('3328883')
,('3328885')
,('M_1084183-1')
,('M_733164-1')
,('M_733164-3')
,('M_733164-5')
,('M_733165-1')
,('M_733165-3')
,('M_733165-5')
,('M_733165-7')
,('3328909')
,('3328911')
,('3328913')
,('3328915')
,('3328917')
,('3335301')
,('3335303')
,('3335305')
,('3335299')
,('3805124-1')
,('3335333')
,('3335335')
,('3335337');


-- Generate the RecordSeriesId
DECLARE @RecordSeriesId INT;
SET @RecordSeriesId = (
    SELECT CASE UPPER(@RecordSeries)
        WHEN 'SR' THEN 1 
        WHEN 'SPED' THEN 2 
        WHEN 'HR' THEN 3 
        WHEN 'AR' THEN 4 
        ELSE 5 
    END
);

-- âœ… Ensure we only proceed if the Record Series has data
IF NOT EXISTS (SELECT 1 FROM dbo.tDocDetails WHERE RSId = @RecordSeriesId AND IsDeleted <> 1)
BEGIN
    PRINT 'No matching records found in tDocDetails!';
    RETURN;
END;

-- âœ… Process the data only if a valid RecordSeriesId is found
IF (@RecordSeriesId IN (1, 2, 3))
BEGIN
    -- ðŸ”¹ CTE for DocIdMetaData (Fetching from `tDocDetails`)
    ;WITH DocIdMetaData AS (
        SELECT
            tDD.Id AS DocDatabaseId,
            LTRIM(RTRIM(tDD.DocIdMetaData)) AS DocIdMetaData
        FROM dbo.tDocDetails tDD
        WHERE tDD.RSId = @RecordSeriesId
            AND tDD.IsDeleted <> 1
            AND LTRIM(RTRIM(tDD.DocIdMetaData)) IN (SELECT LTRIM(RTRIM(DocIdMetaData)) FROM @SelectedDocIdMetaData)
    ),
    
    -- ðŸ”¹ CTE for DocVersionIdMetaData (Fetching from `tDocVersion`)
    DocVersionIdMetaData AS (
        SELECT
            tDV.Id AS DocVersionDatabaseId,
            tDV.DocDetailsId,  -- Needed for joining with tDocDetails
            LTRIM(RTRIM(tDV.DocIdMetaData)) AS DocVersionIdMetaData
        FROM dbo.tDocVersion tDV
        JOIN dbo.tDocDetails tDD ON tDV.DocDetailsId = tDD.Id
        WHERE tDD.RSId = @RecordSeriesId
            AND tDD.IsDeleted <> 1
            AND LTRIM(RTRIM(tDV.DocIdMetaData)) IN (SELECT LTRIM(RTRIM(DocIdMetaData)) FROM @SelectedDocIdMetaData)
    )

    -- ðŸ”¹ Main Query: Now Joining `tDocVersion` as well
    SELECT
        tDD.Id AS DocDatabaseId,
        MD.DocIdMetaData AS DocIdMetaData, -- From DocIdMetaData CTE
        DVMD.DocVersionIdMetaData AS DocVersionIdMetaData, -- From DocVersionIdMetaData CTE
        CONCAT(tARS.DMSDocStorageActivePath, '\', tDD.DocGUID, '.', mFT.FileType) AS PhysicalFilePath
    FROM dbo.tDocDetails tDD
    LEFT JOIN DocIdMetaData MD ON tDD.Id = MD.DocDatabaseId -- âœ… Ensure DocIdMetaData is included
    LEFT JOIN DocVersionIdMetaData DVMD ON tDD.Id = DVMD.DocDetailsId -- âœ… Now pulling from `tDocVersion`
    LEFT JOIN dbo.tAcctRecordSeries tARS ON tDD.RSId = tARS.RecordSeriesId
    LEFT JOIN dbo.mFileTypes mFT ON tDD.FileTypeId = mFT.Id
    WHERE tDD.RSId = @RecordSeriesId
        AND tDD.IsDeleted <> 1
        AND (MD.DocIdMetaData IS NOT NULL OR DVMD.DocVersionIdMetaData IS NOT NULL); -- Ensure at least one match
END;
